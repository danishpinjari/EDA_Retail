<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Retail Sales Analysis</title>
    <link rel="stylesheet" href="/static/css/styles.css">
</head>
<body>
    <header>
        <h1>Retail Sales Analysis Dashboard</h1>
    </header>
    
    <main>
        <section class="summary">
            <h2>Key Insights</h2>
            <div id="insights"></div>
        </section>

        <section class="input-section">
            <h2>Analyze Transaction</h2>
            <label for="transactionIdAnalyze">Enter Transaction ID:</label>
            <input type="number" id="transactionIdAnalyze" placeholder="e.g., 1" required>
            <button id="analyzeButton">Analyze</button>
            <div id="transactionResult"></div>
        </section>

        <section class="visualizations">
            <h2>Sales by Product Category</h2>
            <canvas id="categoryChart"></canvas>

            <h2>Sales by Month</h2>
            <canvas id="monthChart"></canvas>
        </section>

        <section class="details">
            <h2>Transaction Details</h2>
            <table id="transactionTable">
                <thead>
                    <tr>
                        <th>Transaction ID</th>
                        <th>Date</th>
                        <th>Customer ID</th>
                        <th>Gender</th>
                        <th>Age</th>
                        <th>Product Category</th>
                        <th>Quantity</th>
                        <th>Price per Unit</th>
                        <th>Total Amount</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Data will be populated here by JavaScript -->
                </tbody>
            </table>
        </section>

        <section class="transaction-input">
            <h2>Find Transaction by ID</h2>
            <form id="transactionForm">
                <label for="transactionIdInput">Transaction ID:</label>
                <input type="number" id="transactionIdInput" name="transactionId" required>
                <button type="submit">Get Transaction</button>
            </form>
            <div id="transactionOutput"></div>
        </section>

    </main>

    <footer>
        <p>&copy; 2024 Retail Analysis Dashboard</p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        // Fetch insights from the backend
        fetch('/insights')
            .then(response => response.json())
            .then(data => {
                const insightsDiv = document.getElementById('insights');
                insightsDiv.innerHTML = `
                    <p>Total Sales: $${data.total_sales.toFixed(2)}</p>
                    <p>Average Age: ${data.average_age}</p>
                    <p>Male Customers: ${data.male_count}</p>
                    <p>Female Customers: ${data.female_count}</p>
                `;
            });

        // Fetch sales by category from the backend
        fetch('/sales/category')
            .then(response => response.json())
            .then(data => {
                const categoryCtx = document.getElementById('categoryChart').getContext('2d');
                new Chart(categoryCtx, {
                    type: 'bar',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            label: 'Sales by Product Category',
                            data: data.data,
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            });

        // Fetch sales by month from the backend
        fetch('/sales/month')
            .then(response => response.json())
            .then(data => {
                const monthCtx = document.getElementById('monthChart').getContext('2d');
                new Chart(monthCtx, {
                    type: 'line',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            label: 'Sales by Month',
                            data: data.data,
                            borderColor: 'rgba(255, 99, 132, 1)',
                            fill: false
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            });

        // Fetch all transactions from the backend and populate the table
        fetch('/transactions')
            .then(response => response.json())
            .then(transactions => {
                const transactionTable = document.getElementById('transactionTable').querySelector('tbody');
                transactions.forEach(transaction => {
                    const row = transactionTable.insertRow();
                    Object.values(transaction).forEach(value => {
                        const cell = row.insertCell();
                        cell.textContent = value;
                    });
                });
            });

        // Analyze a transaction by its ID
        document.getElementById('analyzeButton').addEventListener('click', () => {
            const transactionId = document.getElementById('transactionIdAnalyze').value;
            
            // Ensure the ID is a valid number
            if (!transactionId) {
                document.getElementById('transactionResult').innerHTML = '<p>Please enter a valid Transaction ID.</p>';
                return;
            }

            // Fetch all transactions and search for the specific one
            fetch('/transactions')
                .then(response => response.json())
                .then(transactions => {
                    const transaction = transactions.find(t => t['Transaction ID'] === Number(transactionId));
                    const resultDiv = document.getElementById('transactionResult');

                    if (transaction) {
                        resultDiv.innerHTML = `
                            <h3>Transaction Details:</h3>
                            <p><strong>Transaction ID:</strong> ${transaction['Transaction ID']}</p>
                            <p><strong>Date:</strong> ${transaction['Date']}</p>
                            <p><strong>Customer ID:</strong> ${transaction['Customer ID']}</p>
                            <p><strong>Gender:</strong> ${transaction['Gender']}</p>
                            <p><strong>Age:</strong> ${transaction['Age']}</p>
                            <p><strong>Product Category:</strong> ${transaction['Product Category']}</p>
                            <p><strong>Quantity:</strong> ${transaction['Quantity']}</p>
                            <p><strong>Price per Unit:</strong> $${transaction['Price per Unit'].toFixed(2)}</p>
                            <p><strong>Total Amount:</strong> $${transaction['Total Amount'].toFixed(2)}</p>
                        `;
                    } else {
                        resultDiv.innerHTML = `<p>No transaction found with ID: ${transactionId}</p>`;
                    }
                });
        });

        // Fetch a specific transaction by ID using the form
        document.getElementById('transactionForm').addEventListener('submit', function(event) {
            event.preventDefault();
            const transactionId = document.getElementById('transactionIdInput').value;

            fetch(`/transactions/${transactionId}`)
                .then(response => response.json())
                .then(data => {
                    const outputDiv = document.getElementById('transactionOutput');
                    if (data.error) {
                        outputDiv.innerHTML = `<p>${data.error}</p>`;
                    } else {
                        outputDiv.innerHTML = `
                            <p><strong>Transaction ID:</strong> ${data.transaction_id}</p>
                            <p><strong>Date:</strong> ${data.date}</p>
                            <p><strong>Customer ID:</strong> ${data.customer_id}</p>
                            <p><strong>Gender:</strong> ${data.gender}</p>
                            <p><strong>Age:</strong> ${data.age}</p>
                            <p><strong>Product Category:</strong> ${data.product_category}</p>
                            <p><strong>Quantity:</strong> ${data.quantity}</p>
                            <p><strong>Price per Unit:</strong> $${data.price_per_unit.toFixed(2)}</p>
                            <p><strong>Total Amount:</strong> $${data.total_amount.toFixed(2)}</p>
                        `;
                    }
                });
        });
    </script>
</body>
</html>
